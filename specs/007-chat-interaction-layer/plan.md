# Implementation Plan: Chat API + Chat UI (Interaction Layer)

**Branch**: `007-chat-interaction-layer` | **Date**: 2026-02-06 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/007-chat-interaction-layer/spec.md`

## Summary

Implement a stateless chat interaction layer that accepts natural language input, persists conversations and messages, delegates reasoning to the AI Agent (Spec-6), and provides a modern, responsive chat UI for hackathon evaluation.

## Technical Context

**Language/Version**: Python 3.11 (Backend), TypeScript 5.0+ (Frontend)  
**Primary Dependencies**: FastAPI, SQLModel, OpenAI Agents SDK, OpenAI ChatKit, httpx  
**Storage**: Neon Serverless PostgreSQL (conversations, messages tables)  
**Testing**: pytest (backend), Jest/React Testing Library (frontend)  
**Target Platform**: Web (desktop + mobile browsers)  
**Project Type**: Web application (frontend + backend)  
**Performance Goals**: <3s response time for 95% of requests  
**Constraints**: Stateless API, WCAG 2.1 AA compliance, JWT authentication  
**Scale/Scope**: Single-user conversations, 50 messages context window

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

| Principle                          | Status  | Notes                                  |
| ---------------------------------- | ------- | -------------------------------------- |
| I. Spec-Driven Development         | ✅ PASS | All implementation from approved spec  |
| II. Security-First Design          | ✅ PASS | JWT auth, user isolation, sanitization |
| III. Deterministic Reproducibility | ✅ PASS | DB-backed state, environment config    |
| IV. Separation of Concerns         | ✅ PASS | 5-layer architecture followed          |
| V. Hackathon Reviewability         | ✅ PASS | Clean UI, documented API               |
| VII. AI & Agent Standards          | ✅ PASS | Reasoning delegated to Spec-6 agent    |
| VIII. MCP Standards                | ✅ PASS | Tool execution via Spec-5 only         |
| IX. Statelessness Standards        | ✅ PASS | No in-memory session storage           |

## High-Level Architecture

```
┌─────────────┐
│   Chat UI   │  Next.js + ChatKit
└──────┬──────┘
       │ POST /api/{user_id}/chat
       ▼
┌─────────────┐
│  Chat API   │  FastAPI (stateless)
└──────┬──────┘
       │ Load/Save
       ▼
┌─────────────┐
│  Database   │  Neon PostgreSQL
└──────┬──────┘
       │ History
       ▼
┌─────────────┐
│  AI Agent   │  Spec-6 (OpenAI Agents SDK)
└──────┬──────┘
       │ Tool calls
       ▼
┌─────────────┐
│  MCP Tools  │  Spec-5 (Task CRUD)
└─────────────┘
```

## Project Structure

### Documentation (this feature)

```text
specs/007-chat-interaction-layer/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research decisions
├── data-model.md        # Entity definitions + SQLModel
├── quickstart.md        # Implementation quickstart
├── contracts/           # API contracts
│   └── chat-api.yaml    # OpenAPI 3.1 specification
└── tasks.md             # Generated by /sp.tasks
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   └── chat.py          # Conversation, Message SQLModel
│   ├── repositories/
│   │   └── chat.py          # DB operations
│   ├── services/
│   │   └── chat.py          # Business logic + agent integration
│   └── api/
│       └── chat.py          # POST /api/{user_id}/chat
└── tests/
    └── test_chat_api.py

frontend/
├── src/
│   ├── app/
│   │   └── chat/
│   │       └── page.tsx     # Chat page (protected route)
│   ├── components/
│   │   └── chat/
│   │       ├── ChatContainer.tsx
│   │       ├── ChatMessageList.tsx
│   │       ├── ChatBubble.tsx
│   │       ├── ChatInput.tsx
│   │       └── TypingIndicator.tsx
│   └── services/
│       └── chatApi.ts       # API client
└── tests/
    └── chat.test.tsx
```

**Structure Decision**: Web application with separate backend (FastAPI) and frontend (Next.js) following existing project structure from Spec-2/3/4.

## Implementation Phases

### Phase 1: Database & Persistence

1. Create SQLModel classes for Conversation and Message
2. Generate and run Alembic migrations
3. Implement repository layer with async functions

### Phase 2: Stateless Chat API

1. Create POST /api/{user_id}/chat endpoint
2. Add JWT authentication middleware
3. Implement request handling flow:
   - Validate JWT and user ownership
   - Create/load conversation
   - Persist user message
   - Invoke AI Agent with history
   - Persist assistant response
   - Return response payload

### Phase 3: AI Agent Integration

1. Import process_message from ai-agent (Spec-6)
2. Format conversation history for agent
3. Handle tool_calls in response
4. Capture tool results for response

### Phase 4: Chat UI Implementation

1. Create protected /chat route
2. Build ChatKit-based components
3. Implement message send/receive flow
4. Add loading and error states

### Phase 5: Responsive & UX Polish

1. Mobile-responsive layout
2. User/assistant message styling
3. Accessibility (ARIA, keyboard navigation)

### Phase 6: Testing

1. API integration tests
2. Unit tests for repository/service
3. Frontend component tests

## Complexity Tracking

No constitution violations. Standard web application pattern.

## Phase 0-1 Outputs

- [x] [research.md](./research.md) - 6 technical decisions resolved
- [x] [data-model.md](./data-model.md) - Conversation, Message entities with SQLModel
- [x] [contracts/chat-api.yaml](./contracts/chat-api.yaml) - OpenAPI 3.1 specification
- [x] [quickstart.md](./quickstart.md) - Implementation guide

## Next Steps

Run `/sp.tasks` to generate actionable implementation tasks.
