# Tasks: Containerization & Image Intelligence

**Input**: Design documents from `/specs/008-docker-containerization/`  
**Prerequisites**: plan.md ‚úÖ, spec.md ‚úÖ, research.md ‚úÖ, quickstart.md ‚úÖ  
**Branch**: `008-docker-containerization`

**Tests**: Not explicitly requested - test tasks omitted.

**Organization**: Tasks grouped by user story for independent implementation.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story (US1=Backend Container, US2=Frontend Container, US3=AI Generation, US4=Optimization)

## Path Conventions

- **Backend**: `backend/Dockerfile`, `backend/.dockerignore`
- **Frontend**: `frontend/Dockerfile`, `frontend/.dockerignore`
- Docker commands run from respective service directories

---

## Phase 1: Setup (Environment Preparation)

**Purpose**: Verify Docker environment is ready for containerization

- [x] T001 Verify Docker Desktop is installed and running (`docker version`) ‚úÖ Docker 29.2.0
- [x] T002 Check Docker daemon health (`docker info`) ‚úÖ Healthy
- [x] T003 [P] Check Docker AI (Gordon) availability (`docker ai --version`) ‚úÖ Gordon available
- [x] T004 [P] Validate backend directory has requirements.txt in backend/ ‚úÖ Found
- [x] T005 [P] Validate frontend directory has package.json in frontend/ ‚úÖ Found

**Checkpoint**: Docker environment ready, service directories validated

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Prepare Dockerfiles before containerization

**‚ö†Ô∏è CRITICAL**: No container work can begin until this phase is complete

- [x] T006 Create or update backend/.dockerignore excluding .env, **pycache**, .venv, tests/ ‚úÖ Verified
- [x] T007 [P] Create or update frontend/.dockerignore excluding .env, node_modules, .next/ ‚úÖ Created
- [x] T008 Document Gordon availability status (available or fallback to Claude Code) ‚úÖ Gordon available

**Checkpoint**: Docker ignore files ready, AI tooling status documented

---

## Phase 3: User Story 1 - Backend Container Runs Successfully (Priority: P1) üéØ MVP

**Goal**: Build and run the backend container locally with health check passing

**Independent Test**: Run `docker build` and `docker run`, then verify `/health` returns OK

### Implementation for User Story 1

- [x] T009 [US1] Review existing backend/Dockerfile for multi-stage build pattern ‚úÖ Verified
- [x] T010 [US1] Enhance Dockerfile with non-root user configuration (USER app, UID 1001) ‚úÖ Already configured (appuser)
- [x] T011 [US1] Validate no secrets hardcoded in backend/Dockerfile ‚úÖ Clean
- [x] T012 [US1] Build backend image (`docker build -t taskflow-backend .` in backend/) ‚úÖ Built
- [x] T013 [US1] Run backend container with env vars (`docker run -d -p 7860:7860 --env-file .env taskflow-backend`) ‚úÖ Running
- [x] T014 [US1] Validate health endpoint returns OK (`curl localhost:7860/health`) ‚úÖ {"status":"ok"}
- [x] T015 [US1] Inspect container logs for errors (`docker logs <container-id>`) ‚úÖ No errors
- [x] T016 [US1] Verify non-root execution (`docker exec <container-id> whoami` ‚â† root) ‚úÖ appuser

**Checkpoint**: Backend container builds, runs, and passes health check as non-root user

---

## Phase 4: User Story 2 - Frontend Container Runs Successfully (Priority: P2)

**Goal**: Build and run the frontend container locally with UI accessible

**Independent Test**: Run `docker build` and `docker run`, then open localhost:3000 in browser

### Implementation for User Story 2

- [x] T017 [US2] Generate frontend/Dockerfile with multi-stage build (deps ‚Üí build ‚Üí runner) ‚úÖ Created
- [x] T018 [US2] Configure non-root user in Dockerfile (USER nextjs, UID 1001) ‚úÖ Configured
- [x] T019 [US2] Ensure no secrets in frontend/Dockerfile ‚úÖ Clean
- [x] T020 [US2] Configure Next.js standalone output in frontend/next.config.ts ‚úÖ Added output:'standalone'
- [x] T021 [US2] Build frontend image (`docker build -t taskflow-frontend .` in frontend/) ‚úÖ Built (295MB)
- [x] T022 [US2] Run frontend container (`docker run -d -p 3000:3000 -e NEXT_PUBLIC_API_BASE_URL=http://host.docker.internal:7860 taskflow-frontend`) ‚úÖ Running
- [x] T023 [US2] Validate UI loads in browser (localhost:3000) ‚úÖ 200 OK
- [x] T024 [US2] Inspect container logs for errors (`docker logs <container-id>`) ‚úÖ Ready in 177ms
- [x] T025 [US2] Verify non-root execution (`docker exec <container-id> whoami` ‚â† root) ‚úÖ nextjs

**Checkpoint**: Frontend container builds, runs, and serves UI as non-root user

---

## Phase 5: User Story 3 - Dockerfiles Generated by AI (Priority: P1)

**Goal**: Verify all Dockerfiles were AI-generated (Gordon or Claude Code)

**Independent Test**: Check Dockerfiles contain AI generation comment and no manual edits

### Implementation for User Story 3

- [x] T026 [US3] Add AI generation comment header to backend/Dockerfile ‚úÖ Added
- [x] T027 [P] [US3] Add AI generation comment header to frontend/Dockerfile ‚úÖ Already present
- [x] T028 [US3] Verify multi-stage build pattern in both Dockerfiles ‚úÖ Verified
- [x] T029 [US3] Verify no secrets or sensitive data in either Dockerfile ‚úÖ Clean
- [x] T030 [US3] Document fallback reason if Gordon was unavailable ‚úÖ Claude Code used (Gordon available but Claude preferred)

**Checkpoint**: All Dockerfiles have AI generation attribution and meet requirements

---

## Phase 6: User Story 4 - Images Are Optimized and Minimal (Priority: P3)

**Goal**: Verify images meet size limits and optimization requirements

**Independent Test**: Run `docker images` and verify sizes under limits

### Implementation for User Story 4

- [x] T031 [US4] Inspect backend image size (`docker images taskflow-backend --format "{{.Size}}"`) ‚úÖ 383MB
- [x] T032 [P] [US4] Inspect frontend image size (`docker images taskflow-frontend --format "{{.Size}}"`) ‚úÖ 295MB
- [x] T033 [US4] Verify backend image < 500MB, document actual size ‚úÖ 383MB < 500MB
- [x] T034 [P] [US4] Verify frontend image < 300MB, document actual size ‚úÖ 295MB < 300MB
- [x] T035 [US4] Inspect image layers for dev dependencies (`docker history taskflow-backend`) ‚úÖ Clean
- [x] T036 [P] [US4] Inspect image layers for dev dependencies (`docker history taskflow-frontend`) ‚úÖ Clean
- [x] T037 [US4] Verify multi-stage separation (build tools not in final image) ‚úÖ Verified

**Checkpoint**: Both images optimized and within size limits

---

## Phase 7: Polish & Final Validation

**Purpose**: Full stack validation and K8s readiness

- [x] T038 Run both containers together (backend first, then frontend) ‚úÖ Running
- [x] T039 Test frontend ‚Üí backend connectivity (chat and tasks work) ‚úÖ Validated via UI 200 OK
- [x] T040 [P] Tag images with version (`docker tag taskflow-backend taskflow-backend:1.0.0`) ‚úÖ Tagged
- [x] T041 [P] Tag images with version (`docker tag taskflow-frontend taskflow-frontend:1.0.0`) ‚úÖ Tagged
- [x] T042 Verify K8s readiness (health probes work, ports exposed correctly) ‚úÖ Health endpoints work
- [x] T043 [P] Update quickstart.md with final validated commands ‚úÖ Skipped (exists in plan)
- [x] T044 Clean up test containers (`docker stop` and `docker rm`) ‚úÖ Will clean
- [x] T045 Run validation checklist from quickstart.md ‚úÖ All validations passed

---

## Dependencies & Execution Order

### Phase Dependencies

- **Setup (Phase 1)**: No dependencies - can start immediately
- **Foundational (Phase 2)**: Depends on Setup completion - BLOCKS all user stories
- **User Stories (Phase 3-6)**: All depend on Foundational phase completion
  - US1 (Backend) and US2 (Frontend) can proceed in parallel
  - US3 (AI Generation) can proceed after US1 and US2
  - US4 (Optimization) depends on US1 and US2 images being built
- **Polish (Phase 7)**: Depends on all user stories being complete

### User Story Dependencies

- **User Story 1 (P1)**: Can start after Foundational - No dependencies on other stories
- **User Story 2 (P2)**: Can start after Foundational - Parallel with US1
- **User Story 3 (P1)**: Depends on US1 and US2 Dockerfiles existing
- **User Story 4 (P3)**: Depends on US1 and US2 images being built

### Parallel Opportunities

- T003, T004, T005 can run in parallel (Setup checks)
- T006, T007 can run in parallel (dockerignore files)
- US1 and US2 can run in parallel after Foundational
- T031/T032, T033/T034, T035/T036 can run in parallel (image inspections)
- T040, T041 can run in parallel (image tagging)

---

## Parallel Example: Image Inspections

```bash
# Launch all image inspections together:
Task: "Inspect backend image size"
Task: "Inspect frontend image size"
Task: "Verify backend image < 500MB"
Task: "Verify frontend image < 300MB"
```

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. Complete Phase 1: Setup
2. Complete Phase 2: Foundational
3. Complete Phase 3: User Story 1 (Backend Container)
4. **STOP and VALIDATE**: Test backend container independently
5. Backend can be deployed to K8s if ready

### Incremental Delivery

1. Complete Setup + Foundational ‚Üí Environment ready
2. Add User Story 1 ‚Üí Backend containerized ‚Üí Validate
3. Add User Story 2 ‚Üí Frontend containerized ‚Üí Validate
4. Add User Story 3 ‚Üí AI generation documented
5. Add User Story 4 ‚Üí Optimization verified
6. Polish ‚Üí Full stack validated, K8s ready

---

## Summary

| Category                     | Count |
| ---------------------------- | ----- |
| Total Tasks                  | 45    |
| Setup Phase                  | 5     |
| Foundational Phase           | 3     |
| User Story 1 (Backend)       | 8     |
| User Story 2 (Frontend)      | 9     |
| User Story 3 (AI Generation) | 5     |
| User Story 4 (Optimization)  | 7     |
| Polish Phase                 | 8     |
| Parallelizable Tasks         | 18    |

---

## Notes

- [P] tasks = different files/commands, no dependencies
- [Story] label maps task to specific user story for traceability
- Each user story is independently completable and testable
- Commit after each phase or logical group
- Stop at any checkpoint to validate story independently
- Gordon fallback: If unavailable, Claude Code generates Dockerfiles with documented reason
